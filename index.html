<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Тест 3D Книги (Mobile Static)</title>

    <script type="module"
            src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js">
    </script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background-color: #f0f0f0;
        }

        @keyframes hover-effect {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        model-viewer {
            width: 100%; height: 100%;
            cursor: pointer;
            background-color: transparent;
            animation: hover-effect 5s ease-in-out infinite;
        }
    </style>
</head>
<body>

<model-viewer
        id="book-model"
        src="final_book.glb"
        alt="A 3D model of a book"
        shadow-intensity="1"

        camera-controls
        disable-zoom
        disable-pan

        touch-action="pan-y"
        interaction-prompt="none"
        animation-name="lol_Armature|Ta...1|BaseLayer.001"
        loop="false"
        orientation="0 90deg 0"
        camera-orbit="20deg 90deg 120%"
>
</model-viewer>

<script>
    // --- Настройки таймеров ---
    const DURATION_PART_1 = 1808;
    const DURATION_PART_2 = 2109;
    const DURATION_TOTAL = 3917;

    // --- Настройка мобильной версии ---
    const MOBILE_BREAKPOINT = 450; // Все, что меньше 768px, считается мобильным

    const modelViewer = document.getElementById('book-model');

    let animationStage = 0;
    let currentTimer = null;

    let isDragging = false;
    let mouseDownTime = 0;

    // 1. Ждем загрузки
    modelViewer.addEventListener('load', () => {
        modelViewer.pause();
        animationStage = 0;
        console.log('Модель загружена. Состояние = 0 (Закрыта)');
    });

    // 2. Отслеживаем "потяг"
    modelViewer.addEventListener('mousedown', () => {
        isDragging = false;
        mouseDownTime = Date.now();
    });

    modelViewer.addEventListener('mousemove', () => {
        isDragging = true;
    });

    // 3. Главный обработчик
    modelViewer.addEventListener('mouseup', () => {
        const timeElapsed = Date.now() - mouseDownTime;

        // Если это был "потяг" (вращение) - выходим
        if (isDragging || timeElapsed >= 250) {
            return;
        }

        // ========================================
        // !! ВОТ ОН, ФИКС ДЛЯ МОБИЛОК !!
        // Если ширина экрана меньше 768px - выходим и НИЧЕГО не делаем.
        if (window.innerWidth < MOBILE_BREAKPOINT) {
            console.log('Это мобильное устройство. Анимация отключена.');
            return;
        }
        // ========================================

        // Если мы здесь, значит это ПК и чистый клик -> запускаем анимацию
        runClickAnimation();
    });

    // 4. Логика анимации
    function runClickAnimation() {
        console.log(`Клик! Текущее состояние = ${animationStage}`);

        if (animationStage === 99) return;

        if (currentTimer) clearTimeout(currentTimer);

        if (animationStage === 0) {
            modelViewer.animationTimeScale = 1;
            modelViewer.currentTime = 0;
            modelViewer.play();
            animationStage = 99;

            currentTimer = setTimeout(() => {
                modelViewer.pause();
                animationStage = 2;
            }, DURATION_PART_1);

        } else if (animationStage === 2) {
            modelViewer.animationTimeScale = 1;
            modelViewer.play();
            animationStage = 99;

            currentTimer = setTimeout(() => {
                modelViewer.pause();
                animationStage = 4;
            }, DURATION_PART_2);

        } else if (animationStage === 4) {
            modelViewer.animationTimeScale = -1;
            modelViewer.play();
            animationStage = 99;

            currentTimer = setTimeout(() => {
                modelViewer.pause();
                animationStage = 0;
            }, DURATION_TOTAL);
        }
    }
</script>

</body>
</html>